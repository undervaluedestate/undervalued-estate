import{r as n,s as c,j as t}from"./index-NQSIgJLP.js";function C({session:h}){var S;const[i,w]=n.useState(null),[p,d]=n.useState([]),[E,g]=n.useState(!0),[f,m]=n.useState(""),[_,x]=n.useState(""),u=n.useRef(null),[R,v]=n.useState(!1),y=n.useRef(null),b=n.useRef(null),l=((S=h==null?void 0:h.user)==null?void 0:S.id)||null;n.useEffect(()=>{(async()=>{if(!c||!l){g(!1);return}const e=c;g(!0),m("");try{let r=null;const{data:s}=await e.from("support_conversations").select("*").eq("user_id",l).maybeSingle();if(s!=null&&s.id)r=s.id;else{const{data:o,error:T}=await e.from("support_conversations").insert({user_id:l}).select("*").single();if(T)throw T;r=o.id}w(r);const{data:a}=await e.from("support_messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});d(a||[])}catch(r){m((r==null?void 0:r.message)||"Failed to load conversation")}finally{g(!1)}})()},[l]),n.useEffect(()=>{if(!c||!i)return;const e=c,r=e.channel(`support:conv:${i}`).on("postgres_changes",{event:"*",schema:"public",table:"support_messages",filter:`conversation_id=eq.${i}`},s=>{if(s.eventType==="INSERT"){d(o=>[...o,s.new]);const a=s.new;a.from_role==="admin"&&e.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("id",a.id).then(()=>{})}else s.eventType==="UPDATE"?d(a=>a.map(o=>o.id===s.new.id?s.new:o)):s.eventType==="DELETE"&&d(a=>a.filter(o=>o.id!==s.old.id))}).on("broadcast",{event:"typing"},s=>{var a;((a=s==null?void 0:s.payload)==null?void 0:a.from)==="admin"&&(v(!0),y.current&&clearTimeout(y.current),y.current=setTimeout(()=>v(!1),2e3))}).subscribe();return b.current=r,()=>{e.removeChannel(r)}},[i]),n.useEffect(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[p.length]),n.useEffect(()=>{(async()=>!c||!i||!l||await c.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("conversation_id",i).eq("from_role","admin"))()},[i,p.length]);async function I(){try{if(!c||!i||!l)return;const e=c,r=_.trim();if(!r)return;x("");const{data:s,error:a}=await e.from("support_messages").insert({conversation_id:i,from_role:"user",sender_id:l,body:r}).select("id").single();if(!a)try{await fetch("http://localhost:5173/api/support/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:s==null?void 0:s.id})})}catch{}}catch{}}const j=!!l,N=n.useMemo(()=>{const e=p.filter(r=>r.from_role==="user");return e.length?e[e.length-1].id:null},[p]);return t.jsxs("div",{className:"card",style:{maxWidth:820,margin:"0 auto"},children:[t.jsxs("div",{className:"meta",style:{justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontWeight:700},children:"Support"}),!j&&t.jsxs("div",{style:{opacity:.8},children:["Please ",t.jsx("a",{href:"#login",children:"log in"})," to chat."]})]}),E&&t.jsx("div",{children:"Loading chat…"}),f&&t.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",f]}),j&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{ref:u,style:{maxHeight:"60vh",overflowY:"auto",padding:8,border:"1px solid rgba(255,255,255,.1)",borderRadius:6},children:[p.length===0&&t.jsx("div",{style:{opacity:.7},children:"Start a conversation with us — we usually reply instantly."}),p.map(e=>{const r=e.from_role==="user";return t.jsx("div",{style:{display:"flex",justifyContent:r?"flex-end":"flex-start",marginBottom:6},children:t.jsxs("div",{style:{maxWidth:"70%",padding:"8px 10px",borderRadius:8,background:r?"rgba(59,130,246,.2)":"rgba(255,255,255,.06)"},children:[t.jsx("div",{style:{whiteSpace:"pre-wrap"},children:e.body}),t.jsx("div",{style:{opacity:.6,fontSize:11,marginTop:4},children:new Date(e.created_at).toLocaleString()}),r&&e.id===N&&e.read_at&&t.jsx("div",{style:{opacity:.7,fontSize:11,marginTop:2},children:"Seen"}),e.property_snapshot&&t.jsxs("div",{style:{marginTop:8,padding:8,border:"1px solid rgba(255,255,255,.12)",borderRadius:6,background:"rgba(255,255,255,.03)"},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:4},children:e.property_snapshot.title||"Listing"}),t.jsxs("div",{className:"meta",style:{gap:8},children:[e.property_snapshot.price!=null&&t.jsxs("span",{children:["Price: ",e.property_snapshot.currency?new Intl.NumberFormat("en-GB",{style:"currency",currency:String(e.property_snapshot.currency).toUpperCase()}).format(Number(e.property_snapshot.price)):e.property_snapshot.price]}),t.jsx("span",{children:"•"}),e.property_snapshot.property_type&&t.jsxs("span",{children:["Type: ",e.property_snapshot.property_type]}),e.property_snapshot.bedrooms!=null&&t.jsxs("span",{children:["• Beds: ",e.property_snapshot.bedrooms]}),e.property_snapshot.bathrooms!=null&&t.jsxs("span",{children:["• Baths: ",e.property_snapshot.bathrooms]})]}),e.property_snapshot.images&&e.property_snapshot.images.length>0&&t.jsx("div",{style:{display:"flex",gap:8,marginTop:6},children:e.property_snapshot.images.slice(0,3).map(s=>t.jsx("img",{src:s,alt:"Listing",style:{width:72,height:72,objectFit:"cover",borderRadius:6,border:"1px solid rgba(255,255,255,.08)"}},s))}),e.property_snapshot.url&&t.jsx("div",{style:{marginTop:6},children:t.jsx("a",{className:"badge",href:e.property_snapshot.url,target:"_blank",rel:"noreferrer",children:"Open Listing"})})]})]})},e.id)})]}),R&&t.jsx("div",{className:"meta",style:{opacity:.7,fontSize:12,marginTop:6},children:"Support is typing…"}),t.jsxs("div",{className:"meta",style:{marginTop:8,position:"sticky",bottom:8,background:"transparent",paddingTop:8},children:[t.jsx("textarea",{placeholder:"Type a message…",value:_,onChange:e=>{x(e.target.value);const r=b.current;r&&e.target.value&&r.send({type:"broadcast",event:"typing",payload:{from:"user"}})},rows:2,style:{flex:1}}),t.jsx("button",{className:"badge",onClick:I,children:"Send"})]})]})]})}export{C as default};
