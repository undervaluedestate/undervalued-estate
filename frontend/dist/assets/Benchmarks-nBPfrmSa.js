import{r as a,j as e,s as S}from"./index-k2i1u5ov.js";const k="http://localhost:5173";function u(h,f="NGN"){if(h==null)return"—";try{return new Intl.NumberFormat("en-NG",{style:"currency",currency:f,maximumFractionDigits:0}).format(h)}catch{return`${h}`}}function Ie({isAdmin:h=!1,isAuthed:f=!1}){const[r,m]=a.useState({country:"Nigeria",state:"",city:"",property_type:"",currency:"",bedrooms:"",bathrooms:""}),[R,F]=a.useState([]),[E,M]=a.useState(!1),[D,U]=a.useState(""),[L,H]=a.useState(null),[d,A]=a.useState({}),[pe,ye]=a.useState([]),[ge,O]=a.useState(!1),[K,W]=a.useState(""),[me,xe]=a.useState([]),[je,G]=a.useState(!1),[z,J]=a.useState(""),[I,X]=a.useState("asc"),[Q,fe]=a.useState({}),[V,Y]=a.useState(null),[ve,p]=a.useState(!1),[P,Z]=a.useState(null),[i,x]=a.useState(null),[ee,y]=a.useState(""),[v,te]=a.useState(!1),[se,b]=a.useState(""),[ne,be]=a.useState(""),[ae,Ne]=a.useState(""),[re,ie]=a.useState(""),[le,oe]=a.useState(!1);async function we(){var t,l;try{if(!S||!i)return;te(!0),b("");const{data:n}=await S.auth.getSession(),o=(l=(t=n==null?void 0:n.session)==null?void 0:t.user)==null?void 0:l.id;if(!o){p(!0);return}const{data:$,error:C}=await S.from("support_conversations").upsert({user_id:o},{onConflict:"user_id"}).select("*").single();if(C)throw C;const T={id:i.id,url:i.url,title:i.title,price:i.price,currency:i.currency,city:i.city,state:i.state,country:i.country,property_type:i.property_type,bedrooms:i.bedrooms,bathrooms:i.bathrooms},{data:j,error:N}=await S.from("support_messages").insert({conversation_id:$.id,from_role:"user",sender_id:o,body:ee||`Inquiry about listing: ${i.title||i.url}`,property_id:i.id,property_snapshot:T}).select("id").single();if(N)throw N;try{await fetch("http://localhost:5173/api/support/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:j==null?void 0:j.id})})}catch{}x(null),y(""),window.location.hash="#support"}catch(n){b((n==null?void 0:n.message)||"Failed to send")}finally{te(!1)}}const ce=a.useMemo(()=>{const t=new URLSearchParams;return Object.entries(r).forEach(([l,n])=>{n!==""&&n!=null&&t.set(l,n)}),t.toString()},[r]);async function Se(){M(!0),U("");try{if(!r.city){F([]);return}const t=await fetch(`${k}/api/clusters/city?${ce}`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const l=await t.json();F(l.data||[])}catch(t){U(t.message||"Failed to load")}finally{M(!1)}}a.useEffect(()=>{Se()},[ce]);async function Ce(){O(!0),W("");try{const t=new URLSearchParams;r.country&&t.set("country",r.country);const l=await fetch(`${k}/api/clusters/cities?${t.toString()}`);if(!l.ok)throw new Error(`HTTP ${l.status}`);const n=await l.json();ye(n.data||[])}catch(t){W(t.message||"Failed to load cities")}finally{O(!1)}}a.useEffect(()=>{Ce()},[r.country]);async function _e(){G(!0),J("");try{const t=await fetch(`${k}/api/clusters/countries`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const l=await t.json();xe(l.data||[])}catch(t){J(t.message||"Failed to load countries")}finally{G(!1)}}return a.useEffect(()=>{_e()},[]),e.jsxs(e.Fragment,{children:[e.jsxs("section",{children:[e.jsxs("div",{className:"card",style:{marginBottom:12},children:[e.jsxs("div",{className:"filters",children:[e.jsxs("select",{className:"select",value:r.country,onChange:t=>m({...r,country:t.target.value,city:""}),children:[e.jsxs("option",{value:"",children:["Select country… ",je?"(loading…)":""]}),me.map(t=>e.jsx("option",{value:t,children:t},t))]}),z&&e.jsxs("span",{style:{color:"var(--warning)"},children:["Countries: ",z]}),e.jsxs("select",{className:"select",value:r.city,onChange:t=>m({...r,city:t.target.value}),children:[e.jsxs("option",{value:"",children:["Select city… ",ge?"(loading…)":""]}),pe.map(t=>e.jsxs("option",{value:t.name,children:[t.name," ",t.count?`(${t.count})`:""]},t.name))]}),e.jsxs("select",{className:"select",value:r.property_type,onChange:t=>m({...r,property_type:t.target.value}),children:[e.jsx("option",{value:"",children:"Any type"}),e.jsx("option",{value:"house",children:"House"}),e.jsx("option",{value:"apartment",children:"Apartment"}),e.jsx("option",{value:"duplex",children:"Duplex"}),e.jsx("option",{value:"townhouse",children:"Townhouse"}),e.jsx("option",{value:"condo",children:"Condo"}),e.jsx("option",{value:"studio",children:"Studio"}),e.jsx("option",{value:"land",children:"Land"}),e.jsx("option",{value:"other",children:"Other"})]}),e.jsxs("select",{className:"select",value:r.currency,onChange:t=>m({...r,currency:t.target.value}),children:[e.jsx("option",{value:"",children:"Any currency"}),e.jsx("option",{value:"NGN",children:"NGN"}),e.jsx("option",{value:"GBP",children:"GBP"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"})]}),e.jsx("input",{className:"input",placeholder:"Bedrooms",value:r.bedrooms,onChange:t=>m({...r,bedrooms:t.target.value})}),e.jsx("input",{className:"input",placeholder:"Bathrooms",value:r.bathrooms,onChange:t=>m({...r,bathrooms:t.target.value})})]}),e.jsxs("div",{className:"meta",style:{justifyContent:"space-between",marginTop:8},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{opacity:.8},children:"Detail sort:"}),e.jsxs("div",{className:"segmented",children:[e.jsx("button",{className:`seg ${I==="asc"?"active":""}`,onClick:()=>X("asc"),children:"Price ↑"}),e.jsx("button",{className:`seg ${I==="desc"?"active":""}`,onClick:()=>X("desc"),children:"Price ↓"})]})]}),K&&e.jsxs("div",{style:{color:"var(--warning)"},children:["Cities: ",K]})]})]}),D&&e.jsxs("div",{className:"card",style:{borderColor:"#ef4444"},children:["Error: ",D]}),E&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"skeleton skeleton-line",style:{width:"40%",marginBottom:10}}),e.jsx("div",{className:"skeleton skeleton-line",style:{width:"70%",marginBottom:10}}),e.jsx("div",{className:"skeleton skeleton-line",style:{width:"55%"}})]}),!E&&!r.city&&e.jsx("div",{className:"card",children:"Enter a city to load clusters."}),!E&&e.jsx("div",{className:"card",children:e.jsx("div",{className:"table",style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-country",style:{textAlign:"left"},children:"Country"}),e.jsx("th",{className:"col-state",style:{textAlign:"left"},children:"State"}),e.jsx("th",{className:"col-city",style:{textAlign:"left"},children:"City"}),e.jsx("th",{className:"col-type",style:{textAlign:"left"},children:"Type"}),e.jsx("th",{className:"col-currency",style:{textAlign:"left"},children:"Currency"}),e.jsx("th",{className:"col-beds",style:{textAlign:"right"},children:"Beds"}),e.jsx("th",{className:"col-baths",style:{textAlign:"right"},children:"Baths"}),e.jsx("th",{className:"col-key",style:{textAlign:"left"},children:"Cluster Key"}),e.jsx("th",{className:"col-sample",style:{textAlign:"right"},children:"Sample"}),e.jsx("th",{className:"col-min",style:{textAlign:"right"},children:"Min"}),e.jsx("th",{className:"col-median",style:{textAlign:"right"},children:"Median"}),e.jsx("th",{className:"col-max",style:{textAlign:"right"},children:"Max"}),e.jsx("th",{className:"col-ppsqm",style:{textAlign:"right"},children:"Avg ppsqm"}),h&&e.jsx("th",{style:{textAlign:"right"},children:"See Listings"})]})}),e.jsxs("tbody",{children:[R.map((t,l)=>{var j,N,B,de,ue;const n=[t.country||"",t.state||"",t.city||"",t.property_type,t.currency,t.bedrooms??"",t.bathrooms??""].join("|"),o=new URLSearchParams;t.country&&o.set("country",t.country),t.state&&o.set("state",t.state),t.city&&o.set("city",t.city),t.property_type&&o.set("property_type",t.property_type),t.currency&&o.set("currency",t.currency),t.bedrooms!=null&&o.set("bedrooms",String(t.bedrooms)),t.bathrooms!=null&&o.set("bathrooms",String(t.bathrooms)),o.set("sort","price"),o.set("order",I);async function $(){A(s=>s[n]?s:{...s,[n]:{loading:!0,error:"",page:1}});try{const s=await fetch(`${k}/api/clusters/city/detail?${o.toString()}&page=1&per_page=10`);if(!s.ok)throw new Error(`HTTP ${s.status}`);const g=await s.json();A(_=>({..._,[n]:{loading:!1,error:"",stats:g.stats,items:g.data,page:1}}))}catch(s){A(g=>({...g,[n]:{loading:!1,error:s.message||"Failed to load",page:1}}))}}const C=async()=>{if(L===n){H(null);return}H(n),d[n]||await $()},T=`#deals?${o.toString()}`;return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{onClick:C,className:"row-hover",style:{cursor:"pointer"},children:[e.jsx("td",{className:"col-country",children:t.country||""}),e.jsx("td",{className:"col-state",children:t.state||""}),e.jsx("td",{className:"col-city",children:t.city||""}),e.jsx("td",{className:"col-type",children:t.property_type}),e.jsx("td",{className:"col-currency",children:t.currency}),e.jsx("td",{className:"col-beds",style:{textAlign:"right"},children:t.bedrooms??""}),e.jsx("td",{className:"col-baths",style:{textAlign:"right"},children:t.bathrooms??""}),e.jsx("td",{className:"col-key",children:t.cluster_key_city||""}),e.jsx("td",{className:"col-sample",style:{textAlign:"right"},children:t.sample_count}),e.jsx("td",{className:"col-min",style:{textAlign:"right"},children:u(t.min_price,t.currency)}),e.jsx("td",{className:"col-median",style:{textAlign:"right"},children:u(t.median_price,t.currency)}),e.jsx("td",{className:"col-max",style:{textAlign:"right"},children:u(t.max_price,t.currency)}),e.jsx("td",{className:"col-ppsqm",style:{textAlign:"right"},children:u(t.avg_ppsqm,t.currency)}),h&&e.jsx("td",{style:{textAlign:"right"},children:e.jsx("a",{className:"badge",href:T,onClick:s=>s.stopPropagation(),children:"See Listings"})})]},`${l}-row`),L===n&&e.jsx("tr",{children:e.jsx("td",{colSpan:h?14:13,children:e.jsx("div",{className:`collapse ${L===n?"open":""}`,children:e.jsxs("div",{className:"card",style:{marginTop:8},children:[((j=d[n])==null?void 0:j.loading)&&e.jsx("div",{children:"Loading listings…"}),!!((N=d[n])!=null&&N.error)&&e.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",(B=d[n])==null?void 0:B.error]}),!!((de=d[n])!=null&&de.stats)&&e.jsxs("div",{className:"meta",style:{justifyContent:"space-between"},children:[e.jsxs("div",{children:["Sample: ",d[n].stats.sample_count]}),e.jsxs("div",{children:["Min: ",u(d[n].stats.min_price,t.currency)]}),e.jsxs("div",{children:["Median: ",u(d[n].stats.median_price,t.currency)]}),e.jsxs("div",{children:["Max: ",u(d[n].stats.max_price,t.currency)]}),e.jsxs("div",{children:["Avg ppsqm: ",u(d[n].stats.avg_ppsqm,t.currency)]})]}),e.jsx("div",{style:{marginTop:8},children:(((ue=d[n])==null?void 0:ue.items)||[]).map(s=>{const g=()=>{if(!f){p(!0);return}fe(c=>{const w={...c},q={...w[n]||{}};return q[s.id]=!q[s.id],w[n]=q,w})},_=s.property_type_label||(s.property_type?String(s.property_type).charAt(0).toUpperCase()+String(s.property_type).slice(1):""),ke=Array.isArray(s.images)?s.images.filter(Boolean):[],he=Array.from(new Set(ke.map(c=>{try{return new URL(String(c),s.url).toString()}catch{return String(c)}}).filter(Boolean))).slice(0,12),Ee=f&&!!(Q[n]&&Q[n][s.id]),Le=()=>{if(!f){Z(s),p(!0);return}x(s),y(`Hi, I have a question about this listing: ${s.title||""}`.trim())};return e.jsxs("div",{style:{padding:"8px 0",borderTop:"1px solid rgba(255,255,255,.06)"},children:[e.jsxs("div",{className:"meta row-hover",role:"button",tabIndex:0,onClick:g,onKeyDown:c=>{c.key==="Enter"&&g()},style:{justifyContent:"space-between",cursor:"pointer"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[_&&e.jsx("span",{className:"badge",style:{background:"rgba(255,255,255,.08)"},children:_}),e.jsx("div",{style:{fontWeight:600},children:s.title||"Listing"}),e.jsx("div",{style:{opacity:.8},children:[s.neighborhood,s.city,s.state].filter(Boolean).join(", ")})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("div",{children:u(s.price,s.currency)}),e.jsx("div",{children:"•"}),e.jsx("div",{children:s.size_sqm?`${s.size_sqm} sqm`:"—"}),e.jsx("div",{children:"•"}),e.jsxs("div",{children:[s.price_per_sqm?u(s.price_per_sqm,s.currency):"—"," /sqm"]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("a",{className:"badge",href:s.url,target:"_blank",rel:"noreferrer",onClick:c=>c.stopPropagation(),children:"Open Listing"}),e.jsx("button",{className:"badge",onClick:c=>{c.stopPropagation(),Le()},children:"💬 Message"})]})]})]}),Ee&&e.jsx("div",{style:{marginTop:8},children:he.length?e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(140px, 1fr))",gap:8},children:he.map(c=>e.jsx("img",{src:c,alt:"Listing image",style:{width:"100%",height:120,objectFit:"cover",borderRadius:6,border:"1px solid rgba(255,255,255,.08)",background:"#111"},onClick:w=>{w.stopPropagation(),Y(c)}},c))}):e.jsx("div",{style:{opacity:.7},children:"No images for this listing."})})]},s.id)})})]})})})},`${l}-detail`)]})}),R.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:13,style:{opacity:.7,padding:"12px 0"},children:"No clusters found for current filters."})})]})]})})})]}),V&&e.jsx("div",{onClick:()=>Y(null),style:{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsx("img",{src:V||void 0,alt:"Preview",style:{maxWidth:"90vw",maxHeight:"90vh",objectFit:"contain",borderRadius:8,boxShadow:"0 10px 30px rgba(0,0,0,.4)"}})}),ve&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Login",tabIndex:-1,onKeyDown:t=>{t.key==="Escape"&&p(!1)},onClick:()=>p(!1),style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:e.jsxs("div",{className:"card",onClick:t=>t.stopPropagation(),style:{maxWidth:420,width:"92%"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Log in"}),re&&e.jsxs("div",{style:{color:"#ef4444",marginBottom:8},children:["Error: ",re]}),e.jsx("input",{autoFocus:!0,type:"email",placeholder:"Email",value:ne,onChange:t=>be(t.target.value)}),e.jsx("input",{type:"password",placeholder:"Password",value:ae,onChange:t=>Ne(t.target.value)}),e.jsxs("div",{className:"meta",style:{justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"badge",onClick:async()=>{try{ie(""),oe(!0);const{error:t}=await S.auth.signInWithPassword({email:ne,password:ae});if(t)throw t;p(!1),P&&(x(P),y(`Hi, I have a question about this listing: ${P.title||""}`.trim()),Z(null))}catch(t){ie((t==null?void 0:t.message)||"Login failed")}finally{oe(!1)}},disabled:le,children:le?"Signing in…":"Sign in"}),e.jsx("button",{className:"badge",onClick:()=>p(!1),style:{background:"transparent"},children:"Close"})]})]})}),i&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Message Support",tabIndex:-1,onKeyDown:t=>{t.key==="Escape"&&!v&&(x(null),y(""),b(""))},onClick:()=>{v||(x(null),y(""),b(""))},style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:e.jsxs("div",{className:"card",onClick:t=>t.stopPropagation(),style:{maxWidth:520,width:"92%"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Message Support"}),se&&e.jsxs("div",{style:{color:"#ef4444",marginBottom:8},children:["Error: ",se]}),e.jsx("textarea",{rows:3,value:ee,onChange:t=>y(t.target.value),placeholder:"Type your message…"}),e.jsxs("div",{className:"meta",style:{justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"badge",onClick:we,disabled:v,children:v?"Sending…":"Send"}),e.jsx("button",{className:"badge",onClick:()=>{v||(x(null),y(""),b(""))},style:{background:"transparent"},children:"Cancel"})]})]})})]})}export{Ie as default};
