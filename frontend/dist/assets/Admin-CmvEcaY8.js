import{r as n,s as i,j as t}from"./index-k2i1u5ov.js";function K({session:b,isAdmin:c}){var U;const[u,g]=n.useState([]),[o,j]=n.useState(null),[f,h]=n.useState([]),[C,N]=n.useState(""),[y,T]=n.useState(""),[E,R]=n.useState(!1),m=n.useRef(null),[P,w]=n.useState(!1),[k,L]=n.useState(""),[$,I]=n.useState(!1),D=n.useRef(null),[p,v]=n.useState("all"),[x,O]=n.useState(""),[_,W]=n.useState({}),[S,q]=n.useState({}),[M,z]=n.useState(new Set),B=((U=b==null?void 0:b.user)==null?void 0:U.id)||null;n.useEffect(()=>{(async()=>{if(!i||!c)return;const e=i;try{R(!0),T("");const{data:s,error:r}=await e.from("support_conversations").select("*").order("updated_at",{ascending:!1});if(r)throw r;g(s||[]),s&&s.length&&!o&&j(s[0].id)}catch(s){T((s==null?void 0:s.message)||"Failed to load conversations")}finally{R(!1)}})()},[c]),n.useEffect(()=>{if(!i||!c)return;const e=i,s=e.channel("support:conv:list").on("postgres_changes",{event:"*",schema:"public",table:"support_conversations"},r=>{r.eventType==="INSERT"?g(a=>[r.new,...a]):r.eventType==="UPDATE"?g(a=>a.map(l=>l.id===r.new.id?r.new:l)):r.eventType==="DELETE"&&g(a=>a.filter(l=>l.id!==r.old.id))}).subscribe();return()=>{e.removeChannel(s)}},[c]),n.useEffect(()=>{(async()=>{if(!i||!o||!c){h([]);return}const e=i,{data:s}=await e.from("support_messages").select("*").eq("conversation_id",o).order("created_at",{ascending:!0});h(s||[])})()},[o,c]),n.useEffect(()=>{if(!i||!o||!c)return;const e=i,s=e.channel(`support:conv:${o}`).on("postgres_changes",{event:"*",schema:"public",table:"support_messages",filter:`conversation_id=eq.${o}`},r=>{r.eventType==="INSERT"?h(a=>[...a,r.new]):r.eventType==="UPDATE"?h(a=>a.map(l=>l.id===r.new.id?r.new:l)):r.eventType==="DELETE"&&h(a=>a.filter(l=>l.id!==r.old.id))}).on("broadcast",{event:"typing"},r=>{var a;((a=r==null?void 0:r.payload)==null?void 0:a.from)==="user"&&(I(!0),setTimeout(()=>I(!1),1500))}).subscribe();return D.current=s,()=>{e.removeChannel(s)}},[o,c]),n.useEffect(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},[f.length]),n.useEffect(()=>{(async()=>!i||!o||!c||await i.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("conversation_id",o).eq("from_role","user"))()},[o,f.length,c]);async function F(){if(!i||!o||!B)return;const e=i,s=C.trim();if(!s)return;N("");const{data:r,error:a}=await e.from("support_messages").insert({conversation_id:o,from_role:"admin",sender_id:B,body:s}).select("id").single();if(!a)try{await fetch("http://localhost:5173/api/support/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:r==null?void 0:r.id})}),L("Reply sent"),setTimeout(()=>L(""),2500)}catch{}}n.useEffect(()=>{(async()=>{if(!i||!c||u.length===0)return;const e=u.map(d=>d.id),{data:s}=await i.from("support_messages").select("conversation_id").is("read_at",null).eq("from_role","user").in("conversation_id",e),r={};(s||[]).forEach(d=>{r[d.conversation_id]=(r[d.conversation_id]||0)+1}),W(r);const{data:a}=await i.from("support_messages").select("conversation_id, from_role, created_at").in("conversation_id",e).order("created_at",{ascending:!1}).limit(1e3),l={};(a||[]).forEach(d=>{d.conversation_id in l||(l[d.conversation_id]=d.from_role)}),q(l);const{data:J}=await i.from("support_messages").select("conversation_id").not("property_snapshot","is",null).in("conversation_id",e).limit(1e3);z(new Set((J||[]).map(d=>d.conversation_id)))})()},[u.length,c]);const H=n.useMemo(()=>{let e=u;if(x){const s=x.toLowerCase();e=e.filter(r=>String(r.user_id).toLowerCase().includes(s))}return p==="unread"?e=e.filter(s=>(_[s.id]||0)>0):p==="waiting"?e=e.filter(s=>S[s.id]==="user"):p==="has_property"&&(e=e.filter(s=>M.has(s.id))),e},[u,_,S,M,p,x]),G=n.useMemo(()=>{const e=f.filter(s=>s.from_role==="admin");return e.length?e[e.length-1].id:null},[f]);return c?t.jsxs("div",{className:"card admin-grid",style:{display:"grid",gridTemplateColumns:"260px 1fr",gap:12},children:[t.jsxs("div",{className:"admin-sidebar",style:{borderRight:"1px solid rgba(255,255,255,.06)",paddingRight:8},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Conversations"}),t.jsx("div",{className:"meta",style:{gap:8,marginBottom:8},children:t.jsxs("div",{className:"segmented",children:[t.jsx("button",{className:`seg ${p==="all"?"active":""}`,onClick:()=>v("all"),children:"All"}),t.jsx("button",{className:`seg ${p==="unread"?"active":""}`,onClick:()=>v("unread"),children:"Unread"}),t.jsx("button",{className:`seg ${p==="waiting"?"active":""}`,onClick:()=>v("waiting"),children:"Waiting"}),t.jsx("button",{className:`seg ${p==="has_property"?"active":""}`,onClick:()=>v("has_property"),children:"Has property"})]})}),t.jsx("input",{className:"input",placeholder:"Search by user id…",value:x,onChange:e=>O(e.target.value)}),E&&t.jsx("div",{children:"Loading…"}),y&&t.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",y]}),t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:H.map(e=>t.jsxs("button",{className:`badge ${o===e.id?"active":""}`,onClick:()=>j(e.id),style:{justifyContent:"flex-start",display:"flex",alignItems:"center",gap:8},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[t.jsxs("div",{style:{fontWeight:600},children:["User ",String(e.user_id).slice(0,8),"…"]}),t.jsx("div",{style:{opacity:.7,fontSize:12},children:new Date(e.updated_at).toLocaleString()})]}),(_[e.id]||0)>0&&t.jsx("span",{className:"badge",style:{background:"rgba(239,68,68,.15)",borderColor:"#ef4444",color:"#ef4444"},children:_[e.id]}),S[e.id]==="user"&&t.jsx("span",{className:"badge",style:{background:"rgba(56,189,248,.15)",borderColor:"var(--brand)",color:"var(--brand)"},children:"waiting"})]},e.id))})]}),t.jsxs("div",{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[t.jsx("div",{style:{fontWeight:700},children:"Conversation"}),t.jsx("button",{className:"badge show-mobile",onClick:()=>w(!0),children:"Conversations"})]}),t.jsxs("div",{ref:m,style:{maxHeight:520,overflowY:"auto",padding:8,border:"1px solid rgba(255,255,255,.1)",borderRadius:6},children:[f.length===0&&t.jsx("div",{style:{opacity:.7},children:"No messages yet."}),f.map(e=>{const s=e.from_role==="admin";return t.jsx("div",{style:{display:"flex",justifyContent:s?"flex-end":"flex-start",marginBottom:6},children:t.jsxs("div",{style:{maxWidth:"70%",padding:"8px 10px",borderRadius:8,background:s?"rgba(59,130,246,.2)":"rgba(255,255,255,.06)"},children:[t.jsx("div",{style:{whiteSpace:"pre-wrap"},children:e.body}),t.jsx("div",{style:{opacity:.6,fontSize:11,marginTop:4},children:new Date(e.created_at).toLocaleString()}),s&&e.id===G&&e.read_at&&t.jsx("div",{style:{opacity:.7,fontSize:11,marginTop:2},children:"Seen"}),e.property_snapshot&&t.jsxs("div",{style:{marginTop:8,padding:8,border:"1px solid rgba(255,255,255,.12)",borderRadius:6,background:"rgba(255,255,255,.03)"},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:4},children:e.property_snapshot.title||"Listing"}),t.jsxs("div",{className:"meta",style:{gap:8},children:[e.property_snapshot.price!=null&&t.jsxs("span",{children:["Price: ",e.property_snapshot.currency?new Intl.NumberFormat("en-GB",{style:"currency",currency:String(e.property_snapshot.currency).toUpperCase()}).format(Number(e.property_snapshot.price)):e.property_snapshot.price]}),t.jsx("span",{children:"•"}),e.property_snapshot.property_type&&t.jsxs("span",{children:["Type: ",e.property_snapshot.property_type]}),e.property_snapshot.bedrooms!=null&&t.jsxs("span",{children:["• Beds: ",e.property_snapshot.bedrooms]}),e.property_snapshot.bathrooms!=null&&t.jsxs("span",{children:["• Baths: ",e.property_snapshot.bathrooms]})]}),e.property_snapshot.url&&t.jsx("div",{style:{marginTop:6},children:t.jsx("a",{className:"badge",href:e.property_snapshot.url,target:"_blank",rel:"noreferrer",children:"Open Listing"})})]})]})},e.id)})]}),$&&t.jsx("div",{className:"meta",style:{opacity:.7,fontSize:12,marginTop:6},children:"User is typing…"}),t.jsxs("div",{className:"meta",style:{marginTop:8},children:[t.jsx("textarea",{placeholder:"Type a reply…",value:C,onChange:e=>{N(e.target.value);const s=D.current;s&&e.target.value&&s.send({type:"broadcast",event:"typing",payload:{from:"admin"}})},rows:2,style:{flex:1}}),t.jsx("button",{className:"badge",onClick:F,children:"Send"})]})]}),P&&t.jsx("div",{className:"drawer",onClick:()=>w(!1),children:t.jsxs("div",{className:"drawer-inner",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Conversations"}),E&&t.jsx("div",{children:"Loading…"}),y&&t.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",y]}),t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:u.map(e=>t.jsx("button",{className:`badge ${o===e.id?"active":""}`,onClick:()=>{j(e.id),w(!1)},style:{justifyContent:"flex-start"},children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[t.jsxs("div",{style:{fontWeight:600},children:["User ",String(e.user_id).slice(0,8),"…"]}),t.jsx("div",{style:{opacity:.7,fontSize:12},children:new Date(e.updated_at).toLocaleString()})]})},e.id))})]})}),!!k&&t.jsx("div",{className:"toast",children:k})]}):t.jsx("div",{className:"card",children:"Only admins can view this page."})}export{K as default};
