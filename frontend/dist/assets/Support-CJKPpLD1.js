import{r as n,s as c,j as t}from"./index-jmXoZW_F.js";function B({session:h,isAdmin:w=!1}){var S;const[a,E]=n.useState(null),[p,d]=n.useState([]),[R,g]=n.useState(!0),[y,m]=n.useState(""),[x,_]=n.useState(""),u=n.useRef(null),[N,v]=n.useState(!1),f=n.useRef(null),b=n.useRef(null),l=((S=h==null?void 0:h.user)==null?void 0:S.id)||null;n.useEffect(()=>{(async()=>{if(!c||!l){g(!1);return}const e=c;g(!0),m("");try{let r=null;const{data:s}=await e.from("support_conversations").select("*").eq("user_id",l).maybeSingle();if(s!=null&&s.id)r=s.id;else{const{data:i,error:T}=await e.from("support_conversations").insert({user_id:l}).select("*").single();if(T)throw T;r=i.id}E(r);const{data:o}=await e.from("support_messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});d(o||[])}catch(r){m((r==null?void 0:r.message)||"Failed to load conversation")}finally{g(!1)}})()},[l]),n.useEffect(()=>{if(!c||!a)return;const e=c,r=e.channel(`support:conv:${a}`).on("postgres_changes",{event:"*",schema:"public",table:"support_messages",filter:`conversation_id=eq.${a}`},s=>{if(s.eventType==="INSERT"){d(i=>[...i,s.new]);const o=s.new;o.from_role==="admin"&&e.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("id",o.id).then(()=>{})}else s.eventType==="UPDATE"?d(o=>o.map(i=>i.id===s.new.id?s.new:i)):s.eventType==="DELETE"&&d(o=>o.filter(i=>i.id!==s.old.id))}).on("broadcast",{event:"typing"},s=>{var o;((o=s==null?void 0:s.payload)==null?void 0:o.from)==="admin"&&(v(!0),f.current&&clearTimeout(f.current),f.current=setTimeout(()=>v(!1),2e3))}).subscribe();return b.current=r,()=>{e.removeChannel(r)}},[a]),n.useEffect(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[p.length]),n.useEffect(()=>{(async()=>!c||!a||!l||await c.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("conversation_id",a).eq("from_role","admin"))()},[a,p.length]);async function I(){try{if(!c||!a||!l)return;const e=c,r=x.trim();if(!r)return;_("");const{data:s,error:o}=await e.from("support_messages").insert({conversation_id:a,from_role:"user",sender_id:l,body:r}).select("id").single();if(!o)try{await fetch("http://localhost:5173/api/support/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:s==null?void 0:s.id})})}catch{}}catch{}}const j=!!l,L=n.useMemo(()=>{const e=p.filter(r=>r.from_role==="user");return e.length?e[e.length-1].id:null},[p]);return t.jsxs("div",{className:"card",style:{maxWidth:820,margin:"0 auto"},children:[t.jsxs("div",{className:"meta",style:{justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontWeight:700},children:"Support"}),!j&&t.jsxs("div",{style:{opacity:.8},children:["Please ",t.jsx("a",{href:"#login",children:"log in"})," to chat."]})]}),R&&t.jsx("div",{children:"Loading chat…"}),y&&t.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",y]}),j&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{ref:u,style:{maxHeight:"60vh",overflowY:"auto",padding:8,border:"1px solid var(--border-soft)",borderRadius:6},children:[p.length===0&&t.jsx("div",{style:{opacity:.7},children:"Start a conversation with us — we usually reply instantly."}),p.map(e=>{const r=e.from_role==="user";return t.jsx("div",{style:{display:"flex",justifyContent:r?"flex-end":"flex-start",marginBottom:6},children:t.jsxs("div",{style:{maxWidth:"70%",padding:"8px 10px",borderRadius:8,background:r?"rgba(59,130,246,.2)":"var(--bubble-other)"},children:[t.jsx("div",{style:{whiteSpace:"pre-wrap"},children:e.body}),t.jsx("div",{style:{opacity:.6,fontSize:11,marginTop:4},children:new Date(e.created_at).toLocaleString()}),r&&e.id===L&&e.read_at&&t.jsx("div",{style:{opacity:.7,fontSize:11,marginTop:2},children:"Seen"}),e.property_snapshot&&t.jsxs("div",{style:{marginTop:8,padding:8,border:"1px solid var(--border-strong)",borderRadius:6,background:"var(--panel-subtle)"},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:4},children:e.property_snapshot.title||"Listing"}),t.jsxs("div",{className:"meta",style:{gap:8},children:[e.property_snapshot.price!=null&&t.jsxs("span",{children:["Price: ",e.property_snapshot.currency?new Intl.NumberFormat("en-GB",{style:"currency",currency:String(e.property_snapshot.currency).toUpperCase()}).format(Number(e.property_snapshot.price)):e.property_snapshot.price]}),t.jsx("span",{children:"•"}),e.property_snapshot.property_type&&t.jsxs("span",{children:["Type: ",e.property_snapshot.property_type]}),e.property_snapshot.bedrooms!=null&&t.jsxs("span",{children:["• Beds: ",e.property_snapshot.bedrooms]}),e.property_snapshot.bathrooms!=null&&t.jsxs("span",{children:["• Baths: ",e.property_snapshot.bathrooms]})]}),e.property_snapshot.images&&e.property_snapshot.images.length>0&&t.jsx("div",{style:{display:"flex",gap:8,marginTop:6},children:e.property_snapshot.images.slice(0,3).map(s=>t.jsx("img",{src:s,alt:"Listing",style:{width:72,height:72,objectFit:"cover",borderRadius:6,border:"1px solid var(--border-soft)"}},s))}),e.property_snapshot.url&&t.jsx("div",{style:{marginTop:6},children:w?t.jsx("a",{className:"badge",href:e.property_snapshot.url,target:"_blank",rel:"noreferrer",children:"Open Listing"}):t.jsx("a",{className:"badge",href:"#login",title:"Admins only. Login as super user to open external listings.",children:"Login as super user"})})]})]})},e.id)})]}),N&&t.jsx("div",{className:"meta",style:{opacity:.7,fontSize:12,marginTop:6},children:"Support is typing…"}),t.jsxs("div",{className:"meta",style:{marginTop:8,position:"sticky",bottom:8,background:"transparent",paddingTop:8},children:[t.jsx("textarea",{placeholder:"Type a message…",value:x,onChange:e=>{_(e.target.value);const r=b.current;r&&e.target.value&&r.send({type:"broadcast",event:"typing",payload:{from:"user"}})},rows:2,style:{flex:1}}),t.jsx("button",{className:"badge",onClick:I,children:"Send"})]})]})]})}export{B as default};
