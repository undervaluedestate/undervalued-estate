import{r as n,s as l,j as t}from"./index-CFJi9e9T.js";function A({session:h,isAdmin:R=!1}){var N;const[o,P]=n.useState(null),[d,u]=n.useState([]),[B,f]=n.useState(!0),[m,x]=n.useState(""),[v,b]=n.useState(""),g=n.useRef(null),[D,_]=n.useState(!1),y=n.useRef(null),j=n.useRef(null),[W,p]=n.useState(!1),[S,q]=n.useState(""),[w,O]=n.useState(""),[T,E]=n.useState(""),[L,C]=n.useState(!1),c=((N=h==null?void 0:h.user)==null?void 0:N.id)||null;n.useEffect(()=>{(async()=>{if(!l||!c){f(!1);return}const e=l;f(!0),x("");try{let r=null;const{data:s}=await e.from("support_conversations").select("*").eq("user_id",c).maybeSingle();if(s!=null&&s.id)r=s.id;else{const{data:i,error:k}=await e.from("support_conversations").insert({user_id:c}).select("*").single();if(k)throw k;r=i.id}P(r);const{data:a}=await e.from("support_messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});u(a||[])}catch(r){x((r==null?void 0:r.message)||"Failed to load conversation")}finally{f(!1)}})()},[c]),n.useEffect(()=>{if(!l||!o)return;const e=l,r=e.channel(`support:conv:${o}`).on("postgres_changes",{event:"*",schema:"public",table:"support_messages",filter:`conversation_id=eq.${o}`},s=>{if(s.eventType==="INSERT"){u(i=>[...i,s.new]);const a=s.new;a.from_role==="admin"&&e.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("id",a.id).then(()=>{})}else s.eventType==="UPDATE"?u(a=>a.map(i=>i.id===s.new.id?s.new:i)):s.eventType==="DELETE"&&u(a=>a.filter(i=>i.id!==s.old.id))}).on("broadcast",{event:"typing"},s=>{var a;((a=s==null?void 0:s.payload)==null?void 0:a.from)==="admin"&&(_(!0),y.current&&clearTimeout(y.current),y.current=setTimeout(()=>_(!1),2e3))}).subscribe();return j.current=r,()=>{e.removeChannel(r)}},[o]),n.useEffect(()=>{g.current&&(g.current.scrollTop=g.current.scrollHeight)},[d.length]),n.useEffect(()=>{(async()=>!l||!o||!c||await l.from("support_messages").update({read_at:new Date().toISOString()}).is("read_at",null).eq("conversation_id",o).eq("from_role","admin"))()},[o,d.length]);async function U(){try{if(!l||!o||!c)return;const e=l,r=v.trim();if(!r)return;b("");const{data:s,error:a}=await e.from("support_messages").insert({conversation_id:o,from_role:"user",sender_id:c,body:r}).select("id").single();if(!a)try{await fetch("http://localhost:5173/api/support/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:s==null?void 0:s.id})})}catch{}}catch{}}const I=!!c,F=n.useMemo(()=>{const e=d.filter(r=>r.from_role==="user");return e.length?e[e.length-1].id:null},[d]);return t.jsxs("div",{className:"card",style:{maxWidth:820,margin:"0 auto"},children:[t.jsxs("div",{className:"meta",style:{justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontWeight:700},children:"Support"}),!I&&t.jsxs("div",{style:{opacity:.8},children:["Please ",t.jsx("a",{href:"#login",children:"log in"})," to chat."]})]}),B&&t.jsx("div",{children:"Loading chat…"}),m&&t.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",m]}),I&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{ref:g,style:{maxHeight:"60vh",overflowY:"auto",padding:8,border:"1px solid var(--border-soft)",borderRadius:6},children:[d.length===0&&t.jsx("div",{style:{opacity:.7},children:"Start a conversation with us — we usually reply instantly."}),d.map(e=>{const r=e.from_role==="user";return t.jsx("div",{style:{display:"flex",justifyContent:r?"flex-end":"flex-start",marginBottom:6},children:t.jsxs("div",{style:{maxWidth:"70%",padding:"8px 10px",borderRadius:8,background:r?"rgba(59,130,246,.2)":"var(--bubble-other)"},children:[t.jsx("div",{style:{whiteSpace:"pre-wrap"},children:e.body}),t.jsx("div",{style:{opacity:.6,fontSize:11,marginTop:4},children:new Date(e.created_at).toLocaleString()}),r&&e.id===F&&e.read_at&&t.jsx("div",{style:{opacity:.7,fontSize:11,marginTop:2},children:"Seen"}),e.property_snapshot&&t.jsxs("div",{style:{marginTop:8,padding:8,border:"1px solid var(--border-strong)",borderRadius:6,background:"var(--panel-subtle)"},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:4},children:e.property_snapshot.title||"Listing"}),t.jsxs("div",{className:"meta",style:{gap:8},children:[e.property_snapshot.price!=null&&t.jsxs("span",{children:["Price: ",e.property_snapshot.currency?new Intl.NumberFormat("en-GB",{style:"currency",currency:String(e.property_snapshot.currency).toUpperCase()}).format(Number(e.property_snapshot.price)):e.property_snapshot.price]}),t.jsx("span",{children:"•"}),e.property_snapshot.property_type&&t.jsxs("span",{children:["Type: ",e.property_snapshot.property_type]}),e.property_snapshot.bedrooms!=null&&t.jsxs("span",{children:["• Beds: ",e.property_snapshot.bedrooms]}),e.property_snapshot.bathrooms!=null&&t.jsxs("span",{children:["• Baths: ",e.property_snapshot.bathrooms]})]}),e.property_snapshot.images&&e.property_snapshot.images.length>0&&t.jsx("div",{style:{display:"flex",gap:8,marginTop:6},children:e.property_snapshot.images.slice(0,3).map(s=>t.jsx("img",{src:s,alt:"Listing",style:{width:72,height:72,objectFit:"cover",borderRadius:6,border:"1px solid var(--border-soft)"}},s))}),e.property_snapshot.url&&t.jsx("div",{style:{marginTop:6},children:t.jsx("a",{className:"badge",href:e.property_snapshot.url,target:"_blank",rel:"noreferrer",onClick:s=>{R||(s.preventDefault(),p(!0))},children:"Open Listings"})})]})]})},e.id)})]}),D&&t.jsx("div",{className:"meta",style:{opacity:.7,fontSize:12,marginTop:6},children:"Support is typing…"}),t.jsxs("div",{className:"meta",style:{marginTop:8,position:"sticky",bottom:8,background:"transparent",paddingTop:8},children:[t.jsx("textarea",{placeholder:"Type a message…",value:v,onChange:e=>{b(e.target.value);const r=j.current;r&&e.target.value&&r.send({type:"broadcast",event:"typing",payload:{from:"user"}})},rows:2,style:{flex:1}}),t.jsx("button",{className:"badge",onClick:U,children:"Send"})]})]}),W&&t.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Login as Super User",tabIndex:-1,onKeyDown:e=>{e.key==="Escape"&&p(!1)},onClick:()=>p(!1),style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:t.jsxs("div",{className:"card",onClick:e=>e.stopPropagation(),style:{maxWidth:420,width:"92%"},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Login as Super User"}),T&&t.jsxs("div",{style:{color:"#ef4444",marginBottom:8},children:["Error: ",T]}),t.jsx("input",{autoFocus:!0,type:"email",placeholder:"Email",value:S,onChange:e=>q(e.target.value)}),t.jsx("input",{type:"password",placeholder:"Password",value:w,onChange:e=>O(e.target.value)}),t.jsxs("div",{className:"meta",style:{justifyContent:"flex-end",marginTop:8},children:[t.jsx("button",{className:"badge",onClick:async()=>{try{E(""),C(!0);const{error:e}=await l.auth.signInWithPassword({email:S,password:w});if(e)throw e;p(!1)}catch(e){E((e==null?void 0:e.message)||"Login failed")}finally{C(!1)}},disabled:L,children:L?"Signing in…":"Sign in"}),t.jsx("button",{className:"badge",onClick:()=>p(!1),style:{background:"transparent"},children:"Close"})]})]})})]})}export{A as default};
