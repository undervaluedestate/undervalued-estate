import{r,j as e,s as k}from"./index-CFJi9e9T.js";const E="http://localhost:5173";function h(p,b="NGN"){if(p==null)return"—";try{return new Intl.NumberFormat("en-NG",{style:"currency",currency:b,maximumFractionDigits:0}).format(p)}catch{return`${p}`}}function $e({isAdmin:p=!1,isAuthed:b=!1}){const[o,y]=r.useState({country:"Nigeria",state:"",city:"",property_type:"",currency:"",bedrooms:"",bathrooms:""}),[R,U]=r.useState([]),[I,D]=r.useState(!1),[F,M]=r.useState(""),[A,H]=r.useState(null),[u,P]=r.useState({}),[pe,ye]=r.useState([]),[ge,K]=r.useState(!1),[G,O]=r.useState(""),[me,xe]=r.useState([]),[je,W]=r.useState(!1),[z,J]=r.useState(""),[$,X]=r.useState("asc"),[Q,fe]=r.useState({}),[V,Y]=r.useState(null),[ve,g]=r.useState(!1),[T,Z]=r.useState(null),[l,f]=r.useState(null),[ee,m]=r.useState(""),[w,te]=r.useState(!1),[se,N]=r.useState(""),[ne,be]=r.useState(""),[re,we]=r.useState(""),[Ne,Se]=r.useState(""),[ae,ie]=r.useState(""),[oe,le]=r.useState(!1);async function Ce(){var t,i;try{if(!k||!l)return;te(!0),N("");const{data:s}=await k.auth.getSession(),a=(i=(t=s==null?void 0:s.session)==null?void 0:t.user)==null?void 0:i.id;if(!a){g(!0);return}const{data:d,error:x}=await k.from("support_conversations").upsert({user_id:a},{onConflict:"user_id"}).select("*").single();if(x)throw x;const S={id:l.id,url:l.url,title:l.title,price:l.price,currency:l.currency,city:l.city,state:l.state,country:l.country,property_type:l.property_type,bedrooms:l.bedrooms,bathrooms:l.bathrooms},{data:v,error:C}=await k.from("support_messages").insert({conversation_id:d.id,from_role:"user",sender_id:a,body:ee||`Inquiry about listing: ${l.title||l.url}`,property_id:l.id,property_snapshot:S}).select("id").single();if(C)throw C;try{await fetch("http://localhost:5173/api/support/notify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:v==null?void 0:v.id})})}catch{}f(null),m(""),window.location.hash="#support"}catch(s){N((s==null?void 0:s.message)||"Failed to send")}finally{te(!1)}}const ce=r.useMemo(()=>{const t=new URLSearchParams;return Object.entries(o).forEach(([i,s])=>{s!==""&&s!=null&&t.set(i,s)}),t.toString()},[o]);async function _e(){D(!0),M("");try{if(!o.city){U([]);return}const t=await fetch(`${E}/api/clusters/city?${ce}`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const i=await t.json();U(i.data||[])}catch(t){M(t.message||"Failed to load")}finally{D(!1)}}r.useEffect(()=>{_e()},[ce]);async function ke(){K(!0),O("");try{const t=new URLSearchParams;o.country&&t.set("country",o.country);const i=await fetch(`${E}/api/clusters/cities?${t.toString()}`);if(!i.ok)throw new Error(`HTTP ${i.status}`);const s=await i.json();ye(s.data||[])}catch(t){O(t.message||"Failed to load cities")}finally{K(!1)}}r.useEffect(()=>{ke()},[o.country]);async function Le(){W(!0),J("");try{const t=await fetch(`${E}/api/clusters/countries`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const i=await t.json();xe(i.data||[])}catch(t){J(t.message||"Failed to load countries")}finally{W(!1)}}return r.useEffect(()=>{Le()},[]),r.useEffect(()=>{var t;try{const i=typeof window<"u"?(t=window.localStorage)==null?void 0:t.getItem("ud_country_pref"):null,s=(a,d)=>a==="NG"||(d||"").toLowerCase().includes("nigeria")?"Nigeria":(a==="GB"||(d||"").toLowerCase().includes("united kingdom")||(d||"").toLowerCase().includes("england")||(d||"").toLowerCase().includes("great britain"),"United Kingdom");if(i){i!==o.country&&y(a=>({...a,country:i,city:""}));return}fetch("https://ipwho.is").then(a=>a.json()).then(a=>{var x;if(!a)return;const d=s(a.country_code,a.country);if(d&&d!==o.country){y(S=>({...S,country:d,city:""}));try{(x=window.localStorage)==null||x.setItem("ud_country_pref",d)}catch{}}}).catch(()=>{})}catch{}},[]),e.jsxs(e.Fragment,{children:[e.jsxs("section",{children:[e.jsxs("div",{className:"card",style:{marginBottom:12},children:[e.jsxs("div",{className:"filters",children:[e.jsxs("select",{className:"select",value:o.country,onChange:t=>{var s;const i=t.target.value;y({...o,country:i,city:""});try{(s=window.localStorage)==null||s.setItem("ud_country_pref",i)}catch{}},children:[e.jsxs("option",{value:"",children:["Select country… ",je?"(loading…)":""]}),me.map(t=>e.jsx("option",{value:t,children:t},t))]}),z&&e.jsxs("span",{style:{color:"var(--warning)"},children:["Countries: ",z]}),e.jsxs("select",{className:"select",value:o.city,onChange:t=>y({...o,city:t.target.value}),children:[e.jsxs("option",{value:"",children:["Select city… ",ge?"(loading…)":""]}),pe.map(t=>e.jsxs("option",{value:t.name,children:[t.name," ",t.count?`(${t.count})`:""]},t.name))]}),e.jsxs("select",{className:"select",value:o.property_type,onChange:t=>y({...o,property_type:t.target.value}),children:[e.jsx("option",{value:"",children:"Any type"}),e.jsx("option",{value:"house",children:"House"}),e.jsx("option",{value:"apartment",children:"Apartment"}),e.jsx("option",{value:"duplex",children:"Duplex"}),e.jsx("option",{value:"townhouse",children:"Townhouse"}),e.jsx("option",{value:"condo",children:"Condo"}),e.jsx("option",{value:"studio",children:"Studio"}),e.jsx("option",{value:"land",children:"Land"}),e.jsx("option",{value:"other",children:"Other"})]}),e.jsxs("select",{className:"select",value:o.currency,onChange:t=>y({...o,currency:t.target.value}),children:[e.jsx("option",{value:"",children:"Any currency"}),e.jsx("option",{value:"NGN",children:"NGN"}),e.jsx("option",{value:"GBP",children:"GBP"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"})]}),e.jsx("input",{className:"input",placeholder:"Bedrooms",value:o.bedrooms,onChange:t=>y({...o,bedrooms:t.target.value})}),e.jsx("input",{className:"input",placeholder:"Bathrooms",value:o.bathrooms,onChange:t=>y({...o,bathrooms:t.target.value})})]}),e.jsxs("div",{className:"meta",style:{justifyContent:"space-between",marginTop:8},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{opacity:.8},children:"Detail sort:"}),e.jsxs("div",{className:"segmented",children:[e.jsx("button",{className:`seg ${$==="asc"?"active":""}`,onClick:()=>X("asc"),children:"Price ↑"}),e.jsx("button",{className:`seg ${$==="desc"?"active":""}`,onClick:()=>X("desc"),children:"Price ↓"})]})]}),G&&e.jsxs("div",{style:{color:"var(--warning)"},children:["Cities: ",G]})]})]}),F&&e.jsxs("div",{className:"card",style:{borderColor:"#ef4444"},children:["Error: ",F]}),I&&e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"skeleton skeleton-line",style:{width:"40%",marginBottom:10}}),e.jsx("div",{className:"skeleton skeleton-line",style:{width:"70%",marginBottom:10}}),e.jsx("div",{className:"skeleton skeleton-line",style:{width:"55%"}})]}),!I&&!o.city&&e.jsx("div",{className:"card",children:"Enter a city to load clusters."}),!I&&e.jsx("div",{className:"card",children:e.jsx("div",{className:"table",style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-country",style:{textAlign:"left"},children:"Country"}),e.jsx("th",{className:"col-state",style:{textAlign:"left"},children:"State"}),e.jsx("th",{className:"col-city",style:{textAlign:"left"},children:"City"}),e.jsx("th",{className:"col-type",style:{textAlign:"left"},children:"Type"}),e.jsx("th",{className:"col-currency",style:{textAlign:"left"},children:"Currency"}),e.jsx("th",{className:"col-beds",style:{textAlign:"right"},children:"Beds"}),e.jsx("th",{className:"col-baths",style:{textAlign:"right"},children:"Baths"}),e.jsx("th",{className:"col-key",style:{textAlign:"left"},children:"Cluster Key"}),e.jsx("th",{className:"col-sample",style:{textAlign:"right"},children:"Sample"}),e.jsx("th",{className:"col-min",style:{textAlign:"right"},children:"Min"}),e.jsx("th",{className:"col-median",style:{textAlign:"right"},children:"Median"}),e.jsx("th",{className:"col-max",style:{textAlign:"right"},children:"Max"}),e.jsx("th",{className:"col-ppsqm",style:{textAlign:"right"},children:"Avg ppsqm"}),p&&e.jsx("th",{style:{textAlign:"right"},children:"See Listings"})]})}),e.jsxs("tbody",{children:[R.map((t,i)=>{var v,C,B,de,ue;const s=[t.country||"",t.state||"",t.city||"",t.property_type,t.currency,t.bedrooms??"",t.bathrooms??""].join("|"),a=new URLSearchParams;t.country&&a.set("country",t.country),t.state&&a.set("state",t.state),t.city&&a.set("city",t.city),t.property_type&&a.set("property_type",t.property_type),t.currency&&a.set("currency",t.currency),t.bedrooms!=null&&a.set("bedrooms",String(t.bedrooms)),t.bathrooms!=null&&a.set("bathrooms",String(t.bathrooms)),a.set("sort","price"),a.set("order",$);async function d(){P(n=>n[s]?n:{...n,[s]:{loading:!0,error:"",page:1}});try{const n=await fetch(`${E}/api/clusters/city/detail?${a.toString()}&page=1&per_page=10`);if(!n.ok)throw new Error(`HTTP ${n.status}`);const j=await n.json();P(L=>({...L,[s]:{loading:!1,error:"",stats:j.stats,items:j.data,page:1}}))}catch(n){P(j=>({...j,[s]:{loading:!1,error:n.message||"Failed to load",page:1}}))}}const x=async()=>{if(A===s){H(null);return}H(s),u[s]||await d()},S=`#deals?${a.toString()}`;return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{onClick:x,className:"row-hover",style:{cursor:"pointer"},children:[e.jsx("td",{className:"col-country",children:t.country||""}),e.jsx("td",{className:"col-state",children:t.state||""}),e.jsx("td",{className:"col-city",children:t.city||""}),e.jsx("td",{className:"col-type",children:t.property_type}),e.jsx("td",{className:"col-currency",children:t.currency}),e.jsx("td",{className:"col-beds",style:{textAlign:"right"},children:t.bedrooms??""}),e.jsx("td",{className:"col-baths",style:{textAlign:"right"},children:t.bathrooms??""}),e.jsx("td",{className:"col-key",children:t.cluster_key_city||""}),e.jsx("td",{className:"col-sample",style:{textAlign:"right"},children:t.sample_count}),e.jsx("td",{className:"col-min",style:{textAlign:"right"},children:h(t.min_price,t.currency)}),e.jsx("td",{className:"col-median",style:{textAlign:"right"},children:h(t.median_price,t.currency)}),e.jsx("td",{className:"col-max",style:{textAlign:"right"},children:h(t.max_price,t.currency)}),e.jsx("td",{className:"col-ppsqm",style:{textAlign:"right"},children:h(t.avg_ppsqm,t.currency)}),p&&e.jsx("td",{style:{textAlign:"right"},children:e.jsx("a",{className:"badge",href:S,onClick:n=>n.stopPropagation(),children:"See Listings"})})]},`${i}-row`),A===s&&e.jsx("tr",{children:e.jsx("td",{colSpan:p?14:13,children:e.jsx("div",{className:`collapse ${A===s?"open":""}`,children:e.jsxs("div",{className:"card",style:{marginTop:8},children:[((v=u[s])==null?void 0:v.loading)&&e.jsx("div",{children:"Loading listings…"}),!!((C=u[s])!=null&&C.error)&&e.jsxs("div",{style:{color:"#ef4444"},children:["Error: ",(B=u[s])==null?void 0:B.error]}),!!((de=u[s])!=null&&de.stats)&&e.jsxs("div",{className:"meta",style:{justifyContent:"space-between"},children:[e.jsxs("div",{children:["Sample: ",u[s].stats.sample_count]}),e.jsxs("div",{children:["Min: ",h(u[s].stats.min_price,t.currency)]}),e.jsxs("div",{children:["Median: ",h(u[s].stats.median_price,t.currency)]}),e.jsxs("div",{children:["Max: ",h(u[s].stats.max_price,t.currency)]}),e.jsxs("div",{children:["Avg ppsqm: ",h(u[s].stats.avg_ppsqm,t.currency)]})]}),e.jsx("div",{style:{marginTop:8},children:(((ue=u[s])==null?void 0:ue.items)||[]).map(n=>{const j=()=>{if(!b){g(!0);return}fe(c=>{const _={...c},q={..._[s]||{}};return q[n.id]=!q[n.id],_[s]=q,_})},L=n.property_type_label||(n.property_type?String(n.property_type).charAt(0).toUpperCase()+String(n.property_type).slice(1):""),Ee=Array.isArray(n.images)?n.images.filter(Boolean):[],he=Array.from(new Set(Ee.map(c=>{try{return new URL(String(c),n.url).toString()}catch{return String(c)}}).filter(Boolean))).slice(0,12),Ie=b&&!!(Q[s]&&Q[s][n.id]),Ae=()=>{if(!b){Z(n),g(!0);return}f(n),m(`Hi, I have a question about this listing: ${n.title||""}`.trim())};return e.jsxs("div",{style:{padding:"8px 0",borderTop:"1px solid var(--border)"},children:[e.jsxs("div",{className:"meta row-hover",role:"button",tabIndex:0,onClick:j,onKeyDown:c=>{c.key==="Enter"&&j()},style:{justifyContent:"space-between",cursor:"pointer"},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[L&&e.jsx("span",{className:"badge",style:{background:"var(--panel-subtle)"},children:L}),e.jsx("div",{style:{fontWeight:600},children:n.title||"Listing"}),e.jsx("div",{style:{opacity:.8},children:[n.neighborhood,n.city,n.state].filter(Boolean).join(", ")})]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("div",{children:h(n.price,n.currency)}),e.jsx("div",{children:"•"}),e.jsx("div",{children:n.size_sqm?`${n.size_sqm} sqm`:"—"}),e.jsx("div",{children:"•"}),e.jsxs("div",{children:[n.price_per_sqm?h(n.price_per_sqm,n.currency):"—"," /sqm"]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("a",{className:"badge",href:n.url,target:"_blank",rel:"noreferrer",onClick:c=>{c.stopPropagation(),p||(c.preventDefault(),Se("super"),g(!0))},children:"Open Listings"}),e.jsx("button",{className:"badge",onClick:c=>{c.stopPropagation(),Ae()},children:"💬 Message"})]})]})]}),Ie&&e.jsx("div",{style:{marginTop:8},children:he.length?e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(140px, 1fr))",gap:8},children:he.map(c=>e.jsx("img",{src:c,alt:"Listing image",style:{width:"100%",height:120,objectFit:"cover",borderRadius:6,border:"1px solid var(--border-soft)",background:"var(--panel)"},onClick:_=>{_.stopPropagation(),Y(c)}},c))}):e.jsx("div",{style:{opacity:.7},children:"No images for this listing."})})]},n.id)})})]})})})},`${i}-detail`)]})}),R.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:13,style:{opacity:.7,padding:"12px 0"},children:"No clusters found for current filters."})})]})]})})})]}),V&&e.jsx("div",{onClick:()=>Y(null),style:{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsx("img",{src:V||void 0,alt:"Preview",style:{maxWidth:"90vw",maxHeight:"90vh",objectFit:"contain",borderRadius:8,boxShadow:"0 10px 30px rgba(0,0,0,.4)"}})}),ve&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Login",tabIndex:-1,onKeyDown:t=>{t.key==="Escape"&&g(!1)},onClick:()=>g(!1),style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:e.jsxs("div",{className:"card",onClick:t=>t.stopPropagation(),style:{maxWidth:420,width:"92%"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:Ne==="super"?"Login as Super User":"Log in"}),ae&&e.jsxs("div",{style:{color:"#ef4444",marginBottom:8},children:["Error: ",ae]}),e.jsx("input",{autoFocus:!0,type:"email",placeholder:"Email",value:ne,onChange:t=>be(t.target.value)}),e.jsx("input",{type:"password",placeholder:"Password",value:re,onChange:t=>we(t.target.value)}),e.jsxs("div",{className:"meta",style:{justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"badge",onClick:async()=>{try{ie(""),le(!0);const{error:t}=await k.auth.signInWithPassword({email:ne,password:re});if(t)throw t;g(!1),T&&(f(T),m(`Hi, I have a question about this listing: ${T.title||""}`.trim()),Z(null))}catch(t){ie((t==null?void 0:t.message)||"Login failed")}finally{le(!1)}},disabled:oe,children:oe?"Signing in…":"Sign in"}),e.jsx("button",{className:"badge",onClick:()=>g(!1),style:{background:"transparent"},children:"Close"})]})]})}),l&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Message Support",tabIndex:-1,onKeyDown:t=>{t.key==="Escape"&&!w&&(f(null),m(""),N(""))},onClick:()=>{w||(f(null),m(""),N(""))},style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:e.jsxs("div",{className:"card",onClick:t=>t.stopPropagation(),style:{maxWidth:520,width:"92%"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Message Support"}),se&&e.jsxs("div",{style:{color:"#ef4444",marginBottom:8},children:["Error: ",se]}),e.jsx("textarea",{rows:3,value:ee,onChange:t=>m(t.target.value),placeholder:"Type your message…"}),e.jsxs("div",{className:"meta",style:{justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"badge",onClick:Ce,disabled:w,children:w?"Sending…":"Send"}),e.jsx("button",{className:"badge",onClick:()=>{w||(f(null),m(""),N(""))},style:{background:"transparent"},children:"Cancel"})]})]})})]})}export{$e as default};
